I"ݻ<p>Amazon used to employ people to recommend readers the books they might be interested in reading next. Not only that wasn’t going to scale well, but when they automated the process of making recommendations, sales had a significant boost.</p>

<p><img src="https://matiasfaure.com/assets/images/primer-on-recommendations/image1.png" alt="png" /></p>

<p><span class="img-caption">My amazon recommendations</span></p>

<p>You’ve probably forgotten by now, but the <a href="http://techblog.netflix.com/2012/06/netflix-recommendations-beyond-5-stars.html">Netflix</a> frontpage became popular overnight because it was loaded with a selection of film categories that was made specifically to entice you. They even ran a <a href="http://netflixprize.com/">million dollar competition</a> to improve their recommendation algorithm. Their recommendations set them apart.</p>

<p><img src="https://matiasfaure.com/assets/images/primer-on-recommendations/image2.png" alt="png" /></p>

<p><span class="img-caption">I’ve never used Netflix to watch Community or Rick and Morty, yet they’ve correctly guessed I’m a Dan Harmon fan!</span></p>

<p><a href="http://www.slideshare.net/MrChrisJohnson/algorithmic-music-recommendations-at-spotify">Spotify</a> knows you won’t stop listening if they can follow up with the right tune. Similarly, YouTube videos are now left on autoplay by default.</p>

<p>We thought we were giving movies and books 1 to 5 ratings to broadcast our tastes, but that was just a ploy to get us to give them a clue on what to push for sale (now imagine what Facebook could do with all of your likes).</p>

<p>You might feel you’re subconsciously losing agency to algorithmic overlords that will influence your choices perpetually. You are right, but this is how things have become and more the reason why <a href="http://new.spectator.co.uk/2015/10/we-let-programmers-run-our-lives-so-hows-their-moral-code/">we have to stay vigilant</a> If you know how they work then you might feel more at ease and easily detect anything suspicious. We do it with Google’s search algorithms, why not Amazon’s recommendations?</p>

<h1 id="ingredients">Ingredients</h1>

<p>Depending on the the type of data the system has access to, the workings of a recommendation engine can vary. In general, there’s three main streams of data you can feed to your platform.</p>

<p><strong>Personalized recommendation</strong> is achieved by inspecting records regarding a specific user. This can include explicit vectors such as movie ratings, age or location, or implicit ones determined by behaviour. For example, skipping songs. The ammount of information services can have about one user is enormous, it can extend to the point in which input for algorithms include what time of the day you check your finances.</p>

<p><strong>Social recommendation</strong> still uses user’s data but places him in a collective context. This can be her group of friends or users who have purchased the same items.</p>

<p><strong>Item recommendation</strong> is achieved by using information about the items themselves. This is often used in a browsing context, where an algorithm searches for products familiar to the object currently being looked at. Again, the metadata is limited to how the architect builds his information to describe a class of items. It can be as simple as registering language, genre, topic and length of a book, or it can go as far as trying to build a collection of genes to tag music with, which is what music streaming service <a href="https://www.pandora.com/about/mgp">Pandora</a> does.</p>

<p>Obviously, you don’t necessarily have to compromise to only one kind of data. In fact, all successful platforms use a combination of every kind of data they can use to make the best guess. However, there are different techniques.</p>

<h1 id="collaborative-filtering">Collaborative Filtering</h1>

<p>In this article I will be going through the <strong>collaborative filtering</strong> technique. It goes through the user preferences of many items to help them collaborate with each other and predict what someone in specific would rate a selected item. Its premise is that if two people have the same bias towards something, then the probability they will rate something else similarly will be higher.</p>

<p>So the key here is to find how similar two users are. Each person will have a similarity score relative to each other. Here’s two ways to find this number.</p>

<p>The <strong>Euclidean distance</strong> is the distance of two people given their preferences. Suppose we have two items X and Y and two people A and B. A has given item X a rating of 2 out of 5 and to item Y, a 4. On the other hand, user B has rated X with a 3 and Y a 2. Using their X and Y preferences, we can place them in a two dimensional plane.</p>

<p><img src="https://matiasfaure.com/assets/images/primer-on-recommendations/image3.png" alt="png" /></p>

<p><span class="img-caption">Euclidean distance graph</span></p>

<p>The distance between the two points is obtained by applying the pythagorean principle. The shorter the distance, the more similar they are. A function that calculates the similarity score should iterate through every item they have both rated, collect their preferences and calculate the overall distance. However, the similarity score is to be proportional to the relatedness, so we need to inverse this given number.</p>

<p>The <strong>Pearson correlation</strong> also uses a preference space, only in this case each axis represents a user and the points an item where their coordinates are the rating given by each person. Say two users X and Y rate 5 items A, B, C, D and E with [3, 3, 2, 5, 4] and [4, 3, 3, 1, 2] respectively. It renders the following graph:</p>

<p><img src="https://matiasfaure.com/assets/images/primer-on-recommendations/image4.png" alt="png" /></p>

<p><span class="img-caption">Pearson correlation graph</span></p>

<p>You can see I also plotted a line of best fit. This line is that one that comes as close to all points as possible. If two users had the same ratings for every item this line would touch all points, so the Pearson score is determined by how close this line comes to every point. Although correlation formula is not as intuitive as the distance formula, <a href="http://www.statisticshowto.com/what-is-the-pearson-correlation-coefficient/">tutorials</a> are widely available since it’s a fundamental concept for applied statistics. The formula should return a value between -1 and 1 where -1 means both users have opposite tastes and 1 is their tastes are exactly the same.</p>

<p>The Pearson correlation is slightly more complicated, hence computationally more expensive, but it will correct for grade inflation. If one critic tends to give out harsher scores than the rest, the correlation will normalize the grades and bring it down to a consistent scale. It is always better to try as many algorithms as possible to see which one is more accurate. You can also look into the coefficient de communauté or the Manhattan distance, they all have a their own advantages.</p>

<h1 id="hands-on">Hands on</h1>

<p>Now that we know how to find a similarity score, we can start writing the program that will do this for us. I’ve been going through R tutorials at <a href="http://www.faure.hu/blog/www.datacamp.com">DataCamp</a>, so I took the challenge of implementing these algorithms in R. Most of it is straightforward and I’ve made sure to comment lines where a step is given so the whole process is clear.</p>

<p>Before we start, make sure you have the R binary and R Studio in your systems. We are going to be using public data from <a href="https://movielens.org/">MovieLens</a>. You can download the compressed .zip file <a href="http://files.grouplens.org/datasets/movielens/ml-100k.zip">here</a>.</p>

<p>The first thing you want to do is inspect what you have. The uncompressed folder contains a variety of text files. If you go over the README file, you’ll learn that it contains 100k movie ratings given by 943 different users to a variety of 1628 films (among other columns of data). The ratings are specified in the u.data file. Its first column contains the ID of the user who rated the film. This movie’s code is in the second column. The rating is in the third column. The last column represents the POSIX time since it’s been created.</p>

<p>This table alone should be enough, but if we want to use the names of the films, we’re going to use the u.item file too. This set contains more columns that includes release date and genres but we since we only need the ID of the movie and its name, we need only to pay attention to the first and second columns.</p>

<p>Once this is clear, we can load the files into our R environment. For this, you need to start R Studio and familiriase yourself with the interface. You will probably find three panes. The largest one on the left side is the console. The other two are your environment are your files viewer, on top and bottom of your left side.</p>

<p><img src="https://matiasfaure.com/assets/images/primer-on-recommendations/image5.png" alt="png" /></p>

<p><span class="img-caption">R Studio when just opened</span></p>

<p>Click ‘Import Dataset’ on the environment tab, select ‘From Text File…’. Select the u.data file you just downloaded and when prompted, change the name of the data frame to something more appropriate. I chose to name it ‘ratings’. You can now click on the import button.</p>

<p>Before actually importing the u.item table, I’d like you to try and preview the data frame by loading the text file but not importing it. You will notice that the rows are probably not tabulated because the selected separator is set to ‘Tabs’. Regardless of anything you choose, none of the listed separators work because this text file has line columns separated by pipe characters. You are going to have to replace those with something R Studio can interpret. The other options are to split the lines by whitespace, comma, or semicolon characters. Since our film names can contain whitespace or commas, semicolons are the best choice.</p>

<p>There’s different ways to replace specific characters on files. I used the following command on my OSX terminal:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="nt">-e</span> <span class="s1">'s/|/;/g'</span> ./path/to/file/_u.item</code></pre></figure>

<p>Now you can finish loading the file. I named my u.item table ‘movies’. You can use the console to play around with these two tables. Try logging ‘movies’, ‘ratings[2]’, or whatever you feel like.</p>

<p>It’s important we have it easy when dealing with this data, so we should name the columns at least for the ratings table. You can do this by using the colnames function. Call the following lines in the console.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span> column_names &lt;- c<span class="o">(</span><span class="s2">"user_id"</span>, <span class="s2">"movie_id"</span>, <span class="s2">"rating"</span>, <span class="s2">"timestamp"</span><span class="o">)</span>
<span class="o">&gt;</span> colnames<span class="o">(</span>ratings<span class="o">)</span> &lt;- column_names</code></pre></figure>

<p>Try the results by logging ratings or ratings$user_id.</p>

<p>Your environment is now properly set up and ready to call some functions. Go to File &gt; New File &gt; R Script and an blank text editor should come up. Here’s the function for calculating the Euclidean distance similarity score:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Returns Euclidean Distance Score between user1 and user2</span><span class="w">
</span><span class="n">euclidean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">ratings_data</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="n">user1</span><span class="p">,</span><span class="w"> </span><span class="n">user2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="c1"># Get the users column from the data</span><span class="w">
	</span><span class="n">users</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="o">$</span><span class="n">user_id</span><span class="w">

	</span><span class="c1">#Retrieve the users and their rated movies</span><span class="w">
	</span><span class="n">first_user</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user1</span><span class="p">,]</span><span class="w">
	</span><span class="n">first_movies</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">first_user</span><span class="o">$</span><span class="n">movie_id</span><span class="w">
	</span><span class="n">second_user</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user2</span><span class="p">,]</span><span class="w">
	</span><span class="n">second_movies</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">second_user</span><span class="o">$</span><span class="n">movie_id</span><span class="w">

	</span><span class="n">squares</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vector</span><span class="p">()</span><span class="w">

	</span><span class="c1">#Loop through both sets of movies</span><span class="w">
		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">movie1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">first_movies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="k">for</span><span class="p">(</span><span class="n">movie2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">second_movies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="c1">#Check if both users have rated the same movies</span><span class="w">
			</span><span class="k">if</span><span class="p">(</span><span class="n">movie1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">movie2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="c1">#Retrieve the rating each gave to the film</span><span class="w">
				</span><span class="n">first_rating</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">first_user</span><span class="p">[</span><span class="n">first_movies</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">movie1</span><span class="p">,]</span><span class="o">$</span><span class="n">rating</span><span class="w">
				</span><span class="n">second_rating</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">second_user</span><span class="p">[</span><span class="n">second_movies</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">movie2</span><span class="p">,]</span><span class="o">$</span><span class="n">rating</span><span class="w">

				</span><span class="c1"># Push the square of the difference</span><span class="w">
				</span><span class="n">squares</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">squares</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">first_rating</span><span class="o">-</span><span class="n">second_rating</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="c1"># Return 0 if they haven't both rated any film</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">squares</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="c1"># Get the sum of the squares</span><span class="w">
	</span><span class="n">squares_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">squares</span><span class="p">)</span><span class="w">

	</span><span class="c1"># Return the score</span><span class="w">
	</span><span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">squares_sum</span><span class="p">))</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>To call this function, you need to load the script to your environment. Do this by pressing the Source option on the right side of the text editor toolbar. Now that ‘euclidean’ is available in your environment, you can call it.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">euclidean</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span></code></pre></figure>

<p>This will give you the similarity score between users with ids 1 and 2. To test if the function actually works, you can try feeding the same users to the function, it should return a similarity score of 1.</p>

<p>Here’s the code for the Pearson correlation function:</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Returns Pearson Correlation between user1 and user2</span><span class="w">
</span><span class="n">pearson</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">ratings_data</span><span class="p">,</span><span class="w"> </span><span class="n">user1</span><span class="p">,</span><span class="w"> </span><span class="n">user2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

	</span><span class="n">users</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="o">$</span><span class="n">user_id</span><span class="w">

	</span><span class="n">first_user</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user1</span><span class="p">,]</span><span class="w">
	</span><span class="n">first_movies</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">first_user</span><span class="o">$</span><span class="n">movie_id</span><span class="w">
	</span><span class="n">second_user</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="o">$</span><span class="n">user_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user2</span><span class="p">,]</span><span class="w">
	</span><span class="n">second_movies</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">second_user</span><span class="o">$</span><span class="n">movie_id</span><span class="w">

	</span><span class="n">rated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vector</span><span class="p">()</span><span class="w">

	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">movie1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">first_movies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="k">for</span><span class="p">(</span><span class="n">movie2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">second_movies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="c1">#This time, if both rated same film then push the movie into rated vector</span><span class="w">
			</span><span class="k">if</span><span class="p">(</span><span class="n">movie1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">movie2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="n">rated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">rated</span><span class="p">,</span><span class="w"> </span><span class="n">movie1</span><span class="p">)</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="n">length</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">rated</span><span class="p">)</span><span class="w">
	</span><span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
	</span><span class="p">}</span><span class="w">

	</span><span class="c1"># Get the ratings</span><span class="w">
	</span><span class="n">first_ratings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">first_user</span><span class="p">[</span><span class="n">first_movies</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">rated</span><span class="p">,]</span><span class="o">$</span><span class="n">rating</span><span class="w">
	</span><span class="n">second_ratings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">second_user</span><span class="p">[</span><span class="n">second_movies</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">rated</span><span class="p">,]</span><span class="o">$</span><span class="n">rating</span><span class="w">

	</span><span class="c1"># Sum of ratings</span><span class="w">
	</span><span class="n">first_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">first_ratings</span><span class="p">)</span><span class="w">
	</span><span class="n">second_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">second_ratings</span><span class="p">)</span><span class="w">

	</span><span class="c1"># Sum of squares of ratings</span><span class="w">
	</span><span class="n">first_sq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">first_ratings</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">
	</span><span class="n">second_sq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">second_ratings</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">

	</span><span class="c1"># sum of product of ratings</span><span class="w">
	</span><span class="n">product_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">first_ratings</span><span class="o">*</span><span class="n">second_ratings</span><span class="p">)</span><span class="w">

	</span><span class="c1"># Calculate the Pearson score and return</span><span class="w">
	</span><span class="n">num</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">product_sum</span><span class="o">-</span><span class="p">(</span><span class="n">first_sum</span><span class="o">*</span><span class="n">second_sum</span><span class="o">/</span><span class="n">length</span><span class="p">)</span><span class="w">
	</span><span class="n">den</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">((</span><span class="n">first_sq</span><span class="o">-</span><span class="p">(</span><span class="n">first_sum</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="n">length</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">second_sq</span><span class="o">-</span><span class="p">(</span><span class="n">second_sum</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">/</span><span class="n">length</span><span class="p">))</span><span class="w">
	</span><span class="n">num</span><span class="o">/</span><span class="n">den</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>This function has the same signature as the previous one, so you call and test it just the same way.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">pearson</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span></code></pre></figure>

<p>Alright, now we have similarity scores but can we actually recommend films to a user? Not quite there yet. We can tell to what extent people are similar to each other, and this can be used to finish the recommender.</p>

<p>You can choose to go through the most similar critics and their favorite films until there’s one movie you haven’t seen yet. But sometimes one similar user can like a film when other similar ones have disliked it. To avoid this, we are going to give each movie a score.</p>

<p>To obtain the recommendation score of a movie, we are going to take the rating each other person gave to the film and multiply it by the similarity score of this person to obtain a weighted score. The sum of all weighted scores would be a very accurate score if it wasn’t for the fact that some movies have been rated more than others, so we are going to divide it by the total of similarity scores. This will give our most correct recommendation score.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Returns films from movies_list sorted by recommendation in descending order</span><span class="w">
</span><span class="n">recommend</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">ratings_data</span><span class="p">,</span><span class="w"> </span><span class="n">movies_list</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">sim_function</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">users</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="o">$</span><span class="n">user_id</span><span class="w">

  </span><span class="c1"># Create arrays for the weighted and numeric scores</span><span class="w">
  </span><span class="n">weighted</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">numeric</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">movies_list</span><span class="p">))</span><span class="w">
  </span><span class="n">sim_sums</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">numeric</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">movies_list</span><span class="p">))</span><span class="w">

  </span><span class="c1"># Get the user ratings</span><span class="w">
  </span><span class="n">user_ratings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user</span><span class="p">,]</span><span class="w">
  </span><span class="c1"># Get the list of movies rated by the user</span><span class="w">
  </span><span class="n">user_movies</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">user_ratings</span><span class="o">$</span><span class="n">movie_id</span><span class="w">

  </span><span class="c1"># Loop the list of users</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">users</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">

    </span><span class="c1"># Skip if the user is the same one</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="k">next</span><span class="p">()</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c1">#Get the similarity score</span><span class="w">
    </span><span class="n">sim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sim_function</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w">
    </span><span class="c1"># If score is 0 or negative, ignore this critic</span><span class="w">
    </span><span class="k">if</span><span class="p">(</span><span class="n">sim</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="k">next</span><span class="p">()</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c1"># Obtain the ratings made by the other user</span><span class="w">
    </span><span class="n">other_ratings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ratings_data</span><span class="p">[</span><span class="n">users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">,]</span><span class="w">

    </span><span class="c1"># Loop through the ratings of the other user</span><span class="w">
    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">other_ratings</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">entry</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">other_ratings</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span><span class="w">

      </span><span class="c1"># Get the rate the user has given this film</span><span class="w">
      </span><span class="n">user_rated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">user_ratings</span><span class="o">$</span><span class="n">rating</span><span class="p">[</span><span class="n">entry</span><span class="o">$</span><span class="n">movie_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user_movies</span><span class="p">]</span><span class="w">
      </span><span class="c1"># Determine if the user rating for this film doesn't exist</span><span class="w">
      </span><span class="n">rate_unexist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">user_rated</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w">
      </span><span class="c1"># Determine if the user rating for this film is 0</span><span class="w">
      </span><span class="n">rate_empty</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">rate_unexist</span><span class="p">)</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">user_rated</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w">

      </span><span class="c1"># Check if the user has not rated this film yet (unexistant or equal to 0)</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rate_unexist</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rate_empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># Log to visualize progress</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w">
        </span><span class="c1"># Collect the total and weighted scores</span><span class="w">
        </span><span class="n">weighted</span><span class="p">[</span><span class="n">entry</span><span class="o">$</span><span class="n">movie_id</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">weighted</span><span class="p">[</span><span class="n">entry</span><span class="o">$</span><span class="n">movie_id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">entry</span><span class="o">$</span><span class="n">rating</span><span class="o">*</span><span class="n">sim</span><span class="w">
        </span><span class="n">sim_sums</span><span class="p">[</span><span class="n">entry</span><span class="o">$</span><span class="n">movie_id</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sim_sums</span><span class="p">[</span><span class="n">entry</span><span class="o">$</span><span class="n">movie_id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sim</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">

  </span><span class="c1"># Get the ranking for each film</span><span class="w">
  </span><span class="n">rankings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w">
  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">weighted</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># Get the name of the film</span><span class="w">
    </span><span class="n">movie_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">levels</span><span class="p">(</span><span class="n">movies</span><span class="p">[,</span><span class="m">2</span><span class="p">]))[</span><span class="n">i</span><span class="p">]</span><span class="w">
    </span><span class="c1"># Save recommendation score to name key</span><span class="w">
    </span><span class="n">rankings</span><span class="p">[[</span><span class="n">movie_name</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">weighted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sim_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">

  </span><span class="c1"># Sort rankings in descending order and return</span><span class="w">
  </span><span class="n">rankings</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">unlist</span><span class="p">(</span><span class="n">rankings</span><span class="p">),</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>You call this function by passing it the ratings table, the movies table, the ID of the user to be recommended and the name of the similarity function you want to use. I recommend you to save it to a variable so you can inspect the result closely.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">recommendation_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recommend</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span><span class="w"> </span><span class="n">movies</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">euclidean</span><span class="p">)</span></code></pre></figure>

<p>This function take noticeably much longer to complete, which is why I have placed a logger inside the nested loop. It takes three minutes in my late 2013 Macbook Pro and it is the most I have been able to optimise without using dedicated libraries or apply functions. This code does go over a lot of stuff and it’s much better than my first draft which took over 9 minutes. You’re very welcome to improve it, if you do please let me know so I can update this with proper credits.</p>

<p>Now that you have the recommendation_list, you can inspect it. Try to see which are the top 20 recommended films for the user by calling recommendation_list[1:20].</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="o">&gt;</span><span class="w"> </span><span class="n">recommendation_list</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">20</span><span class="p">]</span><span class="w">
</span><span class="o">$</span><span class="n">`Prophecy II, The (1998)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Kika (1993)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Paper, The (1994)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Quiet Man, The (1952)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Secret Adventures of Tom Thumb, The (1993)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`That Darn Cat! (1997)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Tin Drum, The (Blechtrommel, Die) (1979)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`True Romance (1993)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Walking Dead, The (1995)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`Wooden Man's Bride, The (Wu Kui) (1994)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">5</span><span class="w">

</span><span class="o">$</span><span class="n">`T-Men (1947)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.701408</span><span class="w">

</span><span class="o">$</span><span class="n">`Star Trek: The Motion Picture (1979)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.658359</span><span class="w">

</span><span class="o">$</span><span class="n">`Bad Girls (1994)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.612912</span><span class="w">

</span><span class="o">$</span><span class="n">`Winter Guest, The (1997)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.597661</span><span class="w">

</span><span class="o">$</span><span class="n">`Parent Trap, The (1961)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.571487</span><span class="w">

</span><span class="o">$</span><span class="n">`Psycho (1960)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.554834</span><span class="w">

</span><span class="o">$</span><span class="n">`Desperado (1995)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.550819</span><span class="w">

</span><span class="o">$</span><span class="n">`Wings of Desire (1987)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.513099</span><span class="w">

</span><span class="o">$</span><span class="n">`Extreme Measures (1996)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.499746</span><span class="w">

</span><span class="o">$</span><span class="n">`Sound of Music, The (1965)`</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">4.489382</span></code></pre></figure>

<p>Awesome stuff.</p>

<p>The accuracy of the recommendation engine can only be validated by the recommendees themselves. Ask them to continue rating films and see if their ratings match. Alternatively, you can remove a single rating from the user, run the recommendation engine and see if the recommendation score of the detached film matches the original one.</p>

<h1 id="want-more">Want more?</h1>

<p>Recommendation engines come in many forms and many people rate their efficiency using different metrics. I hope that with this short tutorial you have gained the basic knowledge to start experimenting with recommenders.</p>

<p>If you are interested in learning more about recommendation engines, I recommend you get your hands on <a href="http://www.amazon.co.uk/Programming-Collective-Intelligence-Building-Applications/dp/0596529325">Programming Collective Intelligence</a> by Toby Segaran. One chapter covers everything we’ve learned today and the rest of the book has more introductions to equally interesting topics.</p>
:ET